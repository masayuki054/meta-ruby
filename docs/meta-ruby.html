<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"https://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="https://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-11-21 月 09:41 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>2016 メタプログラミングRubyのまとめ</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="suzuki@cis.iwate-u.ac.jp" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/sos/css/sos.css">
<link rel="stylesheet" type="text/css" href="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/bigblow/js/jquery.zclip.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/sos/js/hideshow.js"></script>
<script type="text/javascript" src="https://wiki.cis.iwate-u.ac.jp/~suzuki/org-html-theme/styles/sos/js/sos.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">2016 メタプログラミングRubyのまとめ</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline11">1. イントロダクション</a>
<ul>
<li><a href="#orgheadline1">1.1. Ruby のメタプログラミングの例</a></li>
<li><a href="#orgheadline10">1.2. 頭文字 M</a>
<ul>
<li><a href="#orgheadline2">メタプログラミングとは</a>
<ul>
<li><a href="#orgheadline3">コードジェネレータとコンパイラ</a></li>
</ul>
</li>
<li><a href="#orgheadline4">ゴーストタウンと市場</a></li>
<li><a href="#orgheadline7">メタプログラマ ボブの物語</a>
<ul>
<li><a href="#orgheadline5">ボブの最初の試み</a></li>
<li><a href="#orgheadline6">メタプログラミングに突入</a></li>
</ul>
</li>
<li><a href="#orgheadline8">頭文字 M セカンドステージ</a></li>
<li><a href="#orgheadline9">メタプログラミングと Ruby</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline78">2. オブジェクトモデル</a>
<ul>
<li>
<ul>
<li><a href="#orgheadline14">お断り</a>
<ul>
<li><a href="#orgheadline12">記法</a></li>
<li><a href="#orgheadline13">codes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline15">2.1. Object</a></li>
<li><a href="#orgheadline19">2.2. オープンクラス</a>
<ul>
<li><a href="#orgheadline16">クラス定義</a>
<ul>
<li><a href="#orgheadline17">クラス定義の中身</a></li>
<li><a href="#orgheadline18">クラスへの (拡張) メソッドをどこにおくか</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline27">2.3. クラスの真実</a>
<ul>
<li><a href="#orgheadline21">オブジェクトの中身</a>
<ul>
<li><a href="#orgheadline20">instance 変数 (オブジェクトが持つ状態)</a></li>
</ul>
</li>
<li><a href="#orgheadline22">クラス再び</a></li>
<li><a href="#orgheadline23">定数 object_model/constant.rb</a>
<ul>
<li><a href="#orgheadline24">load と名前空間</a></li>
</ul>
</li>
<li><a href="#orgheadline25">オブジェクトとクラスのまとめ</a>
<ul>
<li><a href="#orgheadline26">もう一つの学習機会</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline28">2.4. 引かれていない線</a></li>
<li><a href="#orgheadline38">2.5. メソッドを呼び出すときに何が起きているの?</a>
<ul>
<li><a href="#orgheadline29">メソッドを呼び出すこと</a></li>
<li><a href="#orgheadline30">メソッド探索</a>
<ul>
<li>
<ul>
<li><a href="#orgheadline31">レシーバ</a></li>
<li><a href="#orgheadline32">継承チェーン</a></li>
</ul>
</li>
<li><a href="#orgheadline33">モジュールとメソッド探索</a></li>
<li><a href="#orgheadline34">Kernel</a>
<ul>
<li><a href="#orgheadline35">RubyGems の例</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline36">メソッドの実行</a>
<ul>
<li><a href="#orgheadline37">クラス定義とself</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline39">2.6. オブジェクトとクラスのまとめ</a></li>
<li><a href="#orgheadline40">2.7. 静的言語と動的言語，</a></li>
<li><a href="#orgheadline44">2.8. 重複問題</a>
<ul>
<li><a href="#orgheadline41">レガシーシステム DS</a></li>
<li><a href="#orgheadline42">ダブル，トリプル，トラブル</a>
<ul>
<li><a href="#orgheadline43">重複コード排除のための二つの方針</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline53">2.9. 動的メソッドによる重複コードの排除</a>
<ul>
<li><a href="#orgheadline45">メソッドを動的に呼び出す</a>
<ul>
<li><a href="#orgheadline46">Camping の例</a></li>
<li><a href="#orgheadline47">Test::Unit の例</a></li>
</ul>
</li>
<li><a href="#orgheadline48">メソッドを動的に定義する</a></li>
<li><a href="#orgheadline49">Computerクラスのリファクタリング</a>
<ul>
<li><a href="#orgheadline50">手順1 - 動的ディスパッチャの追加</a></li>
<li><a href="#orgheadline51">手順2 - メソッドを動的に生成する</a></li>
<li><a href="#orgheadline52">手順3 - コードにイントロスペクションをふりかける</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline68">2.10. method_missing()による重複コードの排除</a>
<ul>
<li><a href="#orgheadline54">method_missing の <b>オーバーライド</b></a></li>
<li><a href="#orgheadline55">ghost method</a>
<ul>
<li><a href="#orgheadline56">openstruct</a></li>
</ul>
</li>
<li><a href="#orgheadline57">動的プロキシ</a>
<ul>
<li><a href="#orgheadline58">Flicrの例</a></li>
<li><a href="#orgheadline59">委譲 (コラム)</a>
<ul>
<li><a href="#orgheadline60">DelegateClass() は，ミミックメソッド</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline61">Computerクラスのリファクタリング</a>
<ul>
<li>
<ul>
<li><a href="#orgheadline62">リファクタリングするぜ</a></li>
<li><a href="#orgheadline63">resopond_to?()のオーバーライド</a>
<ul>
<li><a href="#orgheadline64">(({respond_to?()}))のオーバーライド</a></li>
<li><a href="#orgheadline65">(({Object#methods()}))もオーバーライド？</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline66">リファクタリングのまとめ</a>
<ul>
<li><a href="#orgheadline67">const_missing() (コラム)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline69">2.11. クイズ: バグ退治</a></li>
<li><a href="#orgheadline77">2.12. もっと method_missing()</a>
<ul>
<li><a href="#orgheadline70">メソッド名が衝突したら</a>
<ul>
<li><a href="#orgheadline71">パフォーマンスの不安</a></li>
<li><a href="#orgheadline72">Builderの例</a></li>
<li><a href="#orgheadline73">予約済メソッド</a></li>
<li><a href="#orgheadline74">コンピュータクラスの修正</a></li>
<li><a href="#orgheadline75">BasicObject</a></li>
</ul>
</li>
<li><a href="#orgheadline76">まとめ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline79">3. リソース</a></li>
<li><a href="#orgheadline117">4. クラス定義</a>
<ul>
<li><a href="#orgheadline80">4.1. クラスに関する説明のつかない事</a></li>
<li><a href="#orgheadline93">4.2. クラス定義のわかりやすい説明</a>
<ul>
<li><a href="#orgheadline81">クラス定義の中身</a></li>
<li><a href="#orgheadline86">カレントクラス</a>
<ul>
<li><a href="#orgheadline82">Rubyプログラムのコンテキスト(?)</a></li>
<li><a href="#orgheadline83">カレントクラスを参照する方法</a></li>
<li><a href="#orgheadline84">カレントクラスと特別な場合</a></li>
<li><a href="#orgheadline85">class_eval()</a></li>
</ul>
</li>
<li><a href="#orgheadline87">カレントクラスのまとめ</a></li>
<li><a href="#orgheadline88">クラスインスタンス変数</a></li>
<li><a href="#orgheadline89">クラス変数</a></li>
<li><a href="#orgheadline90">Bookwormの作業再び</a>
<ul>
<li><a href="#orgheadline91">Loan#to_s()のユニットテストの問題点</a></li>
<li><a href="#orgheadline92">解決方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline95">4.3. クイズ: クラスのタブー</a>
<ul>
<li><a href="#orgheadline94">クイズの答え</a></li>
</ul>
</li>
<li><a href="#orgheadline100">4.4. 特異メソッド</a>
<ul>
<li><a href="#orgheadline96">特異メソッドの導入</a>
<ul>
<li><a href="#orgheadline97">特異メソッドの実践</a></li>
</ul>
</li>
<li><a href="#orgheadline98">クラスメソッドの真実</a></li>
<li><a href="#orgheadline99">クラスマクロ</a></li>
</ul>
</li>
<li><a href="#orgheadline112">4.5. 特異クラス</a>
<ul>
<li><a href="#orgheadline101">特異メソッドの謎</a></li>
<li><a href="#orgheadline102">特異クラスの出現</a>
<ul>
<li><a href="#orgheadline103">特異クラスを定義する特別な構文</a></li>
<li><a href="#orgheadline104">特異クラスへの参照を得て特異クラスのクラスを見る</a></li>
<li><a href="#orgheadline105">特異クラスに特異メソッドが住んでいる</a></li>
</ul>
</li>
<li><a href="#orgheadline111">メソッド探索再び</a>
<ul>
<li><a href="#orgheadline106">オブジェクトモデルを調べる実践的な例</a></li>
<li><a href="#orgheadline107">特異クラスのスーパークラスは？</a></li>
<li><a href="#orgheadline108">特異クラスの特異クラス</a></li>
<li><a href="#orgheadline109">特異クラスと継承</a></li>
<li><a href="#orgheadline110">大統一理論</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline114">4.6. クイズ: モジュールの不具合</a>
<ul>
<li><a href="#orgheadline113">Object#extend</a></li>
</ul>
</li>
<li><a href="#orgheadline115">4.7. エイリアス</a></li>
<li><a href="#orgheadline116">4.8. クイズ: 壊れた計算</a></li>
</ul>
</li>
<li><a href="#orgheadline163">5. ブロック</a>
<ul>
<li><a href="#orgheadline121">5.1. ブロックの基本</a>
<ul>
<li><a href="#orgheadline118">ブロックの作成</a></li>
<li><a href="#orgheadline119">ブロックが与えられているか？</a></li>
<li><a href="#orgheadline120">ブロックの呼び出し</a></li>
</ul>
</li>
<li><a href="#orgheadline125">5.2. クイズ: Ruby#</a>
<ul>
<li><a href="#orgheadline122">using</a></li>
<li><a href="#orgheadline123">using のテスト</a></li>
<li><a href="#orgheadline124">using の実装</a></li>
</ul>
</li>
<li><a href="#orgheadline136">5.3. クロージャ</a>
<ul>
<li><a href="#orgheadline126">コードの実行</a>
<ul>
<li><a href="#orgheadline127">ブロックローカル変数</a></li>
</ul>
</li>
<li><a href="#orgheadline128">スコープ</a>
<ul>
<li><a href="#orgheadline129">スコープの変更</a></li>
<li><a href="#orgheadline130">((<b>スコープゲート</b>))</a></li>
</ul>
</li>
<li><a href="#orgheadline131">スコープのフラット化</a>
<ul>
<li><a href="#orgheadline132">クラスゲートを越える</a></li>
<li><a href="#orgheadline133">メソッドゲートを越える</a></li>
<li><a href="#orgheadline134">スコープの共有化</a></li>
</ul>
</li>
<li><a href="#orgheadline135">スコープのまとめ</a></li>
</ul>
</li>
<li><a href="#orgheadline141">5.4. instance_eval()</a>
<ul>
<li><a href="#orgheadline137">instance_exec (ruby 1.9)</a></li>
<li><a href="#orgheadline138">カプセル化の破壊</a>
<ul>
<li><a href="#orgheadline139">RSpecの例</a></li>
</ul>
</li>
<li><a href="#orgheadline140">クリーンルーム</a></li>
</ul>
</li>
<li><a href="#orgheadline152">5.5. 呼び出し可能オブジェクト</a>
<ul>
<li>
<ul>
<li><a href="#orgheadline142">Procオブジェクト</a>
<ul>
<li><a href="#orgheadline143">&amp;修飾</a></li>
<li><a href="#orgheadline144">HighLineの例</a></li>
</ul>
</li>
<li><a href="#orgheadline145">Proc 対 lambda</a>
<ul>
<li><a href="#orgheadline146">Proc, lambda, return</a></li>
<li><a href="#orgheadline147">Proc, lambda, arity</a></li>
<li><a href="#orgheadline148">Proc対lambda: 判定</a></li>
<li><a href="#orgheadline149">Kernel#proc</a></li>
</ul>
</li>
<li><a href="#orgheadline150">メソッド再び</a></li>
<li><a href="#orgheadline151">呼び出し可能オブジェクトのまとめ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline161">5.6. ドメイン特化言語を書く</a>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#orgheadline153">初めてのDSL</a></li>
<li><a href="#orgheadline154">イベント間の共有</a></li>
</ul>
</li>
<li><a href="#orgheadline155">クイズ: より良い DSL</a>
<ul>
<li><a href="#orgheadline156">ビルの逃亡</a></li>
<li><a href="#orgheadline157">クイズの答え</a>
<ul>
<li><a href="#orgheadline158">redfalg.rb の中身</a></li>
<li><a href="#orgheadline159">@setups, @events はグローバル変数のようで良くない</a></li>
</ul>
</li>
<li><a href="#orgheadline160">もっと良いDSL</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline162">5.7. 参考</a></li>
</ul>
</li>
<li><a href="#orgheadline174">6. メタプログラミング Ruby のまとめ</a>
<ul>
<li><a href="#orgheadline164">6.1. 計算のモデルとプログラミング言語</a></li>
<li><a href="#orgheadline165">6.2. オブジェクト指向パラダイムとは</a></li>
<li><a href="#orgheadline173">6.3. rubyのやり方</a>
<ul>
<li><a href="#orgheadline166">オブジェクトモデル</a></li>
<li><a href="#orgheadline167">クラスもオブジェクト</a></li>
<li><a href="#orgheadline168">名前の探索</a></li>
<li><a href="#orgheadline169">動的な定義</a></li>
<li><a href="#orgheadline170">メタプログラマブル</a></li>
<li><a href="#orgheadline171">スコープとクロージャで，ブロックもオブジェクト</a></li>
<li><a href="#orgheadline172">オブジェクトと特異クラスとクラス階層</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<a href="./">ホーム</a> /
<a href="./lects.html">講義</a> /
<a href="./ruby.html">ruby</a> / 
<a href="./oo.html">OO</a> / 
<a href="./emacs.html">emacs</a> / 
<a href="./meta-ruby.html">meta-ruby</a> /
<a href="./note.html">note</a> /
<a href="https://github.com/masayuki054/meta-ruby">github-repos</a> /
<a href="https://wiki.cis.iwate-u.ac.jp/~suzuki/lects/meta-ruby/">2015</a>
</p>
<div id="outline-container-orgheadline11" class="outline-2">
<h2 id="orgheadline11"><span class="section-number-2">1</span> イントロダクション</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-orgheadline1" class="outline-3">
<h3 id="orgheadline1"><span class="section-number-3">1.1</span> Ruby のメタプログラミングの例</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>外部システムに接続する Rubyプログラムで，
あらゆるメソッド呼び出しを受付，
それを外部システムに送ることのできるラッパが書ける</li>
<li>DSLを Ruby を拡張することで実現する</li>
<li>Java プログラマには想像もできないレベルで，コードの重複の排除が可能</li>
<li>どんなクラスにも自分の欲しいメソッドが追加でき</li>
<li>監視したいメソッドの始めと終わりにロギング機能を追加できる</li>
<li>好きなクラスをすきな時に継承できる</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline10" class="outline-3">
<h3 id="orgheadline10"><span class="section-number-3">1.2</span> 頭文字 M</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-orgheadline2" class="outline-4">
<h4 id="orgheadline2">メタプログラミングとは</h4>
<div class="outline-text-4" id="text-orgheadline2">
<p>
コードを記述するコードを記述すること
</p>
</div>
<div id="outline-container-orgheadline3" class="outline-5">
<h5 id="orgheadline3">コードジェネレータとコンパイラ</h5>
<div class="outline-text-5" id="text-orgheadline3">
<p>
コードジェネレータとコンパイラは静的メタプログラミング
Rubyでは((* 動的メタプログラミングが可能 *))
</p>
<ul class="org-ul">
<li>実行時に自分自身を操作するメタプログラミング</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-4">
<h4 id="orgheadline4">ゴーストタウンと市場</h4>
<div class="outline-text-4" id="text-orgheadline4">
<p>
ソースコードを活気ある住民であふれた世界と考える
そこには ((* 変数 <b>))，((</b> クラス <b>))，((</b> メソッド *)) が住む
それらを言語要素と呼ぼう
多くのプログラミング言語で，言語要素は，肉体のないゴーストだ
ソースコードに居るときは目に見えるが，
実行時には姿が消える．まるでゴーストタウンだ．
</p>
<ul class="org-ul">
<li>C++では実行時にインスタンスメソッドについて質問することはできない</li>
</ul>
<p>
Rubyでは，実行時もにぎやかな市場だ
</p>
</div>
</div>

<div id="outline-container-orgheadline7" class="outline-4">
<h4 id="orgheadline7">メタプログラマ ボブの物語</h4>
<div class="outline-text-4" id="text-orgheadline7">
</div><div id="outline-container-orgheadline5" class="outline-5">
<h5 id="orgheadline5">ボブの最初の試み</h5>
<div class="outline-text-5" id="text-orgheadline5">
<p>
introduction/orm.rb
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/introduction/orm.rb#MissingReference">introduction/orm.rb</a>
オブジェクト関係マッピングを行うコード
</p>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-5">
<h5 id="orgheadline6">メタプログラミングに突入</h5>
<div class="outline-text-5" id="text-orgheadline6">
<p>
introduction/orm-meta.rb
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/introduction/orm-meta.rb#MissingReference">introduction/orm-meta.rb</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-4">
<h4 id="orgheadline8">頭文字 M セカンドステージ</h4>
<div class="outline-text-4" id="text-orgheadline8">
<p>
メタプログラミングとは，言語要素を実行時に操作するコードを記述す
ること
ActiveRecord::Base を継承するだけで，
実行時にアクセッサメソッドが定義できる
</p>
</div>
</div>
<div id="outline-container-orgheadline9" class="outline-4">
<h4 id="orgheadline9">メタプログラミングと Ruby</h4>
<div class="outline-text-4" id="text-orgheadline9">
<p>
Ruby は現在，もっともメタプログラミングに適した言語
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline78" class="outline-2">
<h2 id="orgheadline78"><span class="section-number-2">2</span> オブジェクトモデル</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgheadline14" class="outline-4">
<h4 id="orgheadline14">お断り</h4>
<div class="outline-text-4" id="text-orgheadline14">
</div><div id="outline-container-orgheadline12" class="outline-5">
<h5 id="orgheadline12">記法</h5>
<div class="outline-text-5" id="text-orgheadline12">
<p>
もともとは RubyDocument (RD) で書いた文書を Emacs Org-mode にしまし
た。RDが優れている記法はそのまま残してあります。
</p>

<p>
((&#x2026;)) の箇所です。(({&#x2026;})) Rubyソース・コードです。
</p>
</div>
</div>

<div id="outline-container-orgheadline13" class="outline-5">
<h5 id="orgheadline13">codes</h5>
<div class="outline-text-5" id="text-orgheadline13">
<p>
教科書中のコードをダウンロードしたものを，org-mode にし
て，~suzuki/lects/meta-ruby/code/object_model_src.org に置きました。
copy して使ってください。
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline15" class="outline-3">
<h3 id="orgheadline15"><span class="section-number-3">2.1</span> Object</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<a href="https://docs.ruby-lang.org/ja/2.0.0/doc/spec=2fobject.html">オブジェクト (Ruby 2.0.0)</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline19" class="outline-3">
<h3 id="orgheadline19"><span class="section-number-3">2.2</span> オープンクラス</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/alphanumeric.rb">alphanumeric.rb</a>
</p>

<p>
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/test_alphanumeric.rb"><a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/test_alphanumeric.rb">file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/test_alphanumeric.rb</a></a>
</p>

<p>
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/replace.rb"><a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/replace.rb">file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/replace.rb</a></a>
</p>

<ul class="org-ul">
<li>クラスは定数で，</li>

<li>クラス定数で指定でき， String, class String &#x2026; end;</li>

<li>変更に対して開かれている．</li>
</ul>
</div>

<div id="outline-container-orgheadline16" class="outline-4">
<h4 id="orgheadline16">クラス定義</h4>
<div class="outline-text-4" id="text-orgheadline16">
<div class="org-src-container">

<pre class="src src-ruby">3.times do
  class C
    puts "Hello"
  end
end
'end'
</pre>
</div>
</div>


<div id="outline-container-orgheadline17" class="outline-5">
<h5 id="orgheadline17">クラス定義の中身</h5>
<div class="outline-text-5" id="text-orgheadline17">
<p>
(({class})) はそのクラスのスコープを開き，(({end}))までの間のプログラムを
そのスコープ内で，実行していく
</p>

<ul class="org-ul">
<li>既存のメソッドを（無意識に）変更することもできる．</li>

<li>無意識は問題だが，意識的な場合は便利なこときまわりない．</li>
</ul>


<p>
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/open_class.rb"><a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/open_class.rb">file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/open_class.rb</a></a>
</p>
</div>
</div>


<div id="outline-container-orgheadline18" class="outline-5">
<h5 id="orgheadline18">クラスへの (拡張) メソッドをどこにおくか</h5>
<div class="outline-text-5" id="text-orgheadline18">
<ul class="org-ul">
<li>(({class String}))と書けば，既存の String クラスが開かれ，変更可
能．</li>

<li>(({calss MyString &lt; String})) と書けば，独自の String クラスの拡張
が作れる．</li>

<li>(({def s.method &#x2026; end})) と書けば，あるオブジェクトだけが拡張で
きる</li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-orgheadline27" class="outline-3">
<h3 id="orgheadline27"><span class="section-number-3">2.3</span> クラスの真実</h3>
<div class="outline-text-3" id="text-2-3">
<p>
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/class.rb"><a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/class.rb">file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/class.rb</a></a>
</p>
</div>

<div id="outline-container-orgheadline21" class="outline-4">
<h4 id="orgheadline21">オブジェクトの中身</h4>
<div class="outline-text-4" id="text-orgheadline21">
</div><div id="outline-container-orgheadline20" class="outline-5">
<h5 id="orgheadline20">instance 変数 (オブジェクトが持つ状態)</h5>
<div class="outline-text-5" id="text-orgheadline20">
<p>
<a href="file://~suzuki/COMM/Prog/ruby/meta/object_model/object_instance_variables.rb">object_instance_variables.rb</a>
</p>

<ul class="org-ul">
<li>インスタンス変数はオブジェクトにあり，</li>
<li>メソッドはクラスにある</li>
<li>オブジェクトに所属するメソッドは，特異（メソッド）</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgheadline22" class="outline-4">
<h4 id="orgheadline22">クラス再び</h4>
<div class="outline-text-4" id="text-orgheadline22">
<p>
「(({class C})) 定義されるクラス C もオブジェクト」
</p>

<ul class="org-ul">
<li>クラスは Class クラスのオブジェクト。
CはClass クラスのオブジェクト</li>
</ul>

<p>
o.class, (o.class).instance_methods, C.superclass, C.ancestors
</p>

<p>
Classは，(({new()})), (({allocate()})), (({superclass()})) のメソッ
ドが追加された Module 
</p>
</div>
</div>

<div id="outline-container-orgheadline23" class="outline-4">
<h4 id="orgheadline23">定数 object_model/constant.rb</h4>
<div class="outline-text-4" id="text-orgheadline23">
<p>
<a href="file:///users/home/masayuki/COMM/Prog/ruby/meta/object_model/constant.rb">constant.rb</a>
</p>

<p>
モジュール構造の入れ子構造が定数のスコープ．
</p>

<div class="org-src-container">

<pre class="src src-ruby">module MyModule
  MyConstant = 1
  class MyClass
    MyConstant = 2
  end
end
</pre>
</div>

<p>
二つの定数のパス
</p>
<ul class="org-ul">
<li>::MyModule::MyConstant</li>
<li>::MyModule::MyClass::MyConstant</li>
</ul>

<p>
定数をまとめるだけのモジュールのことを，((<b>ネームスペース</b>))と呼ぶ
</p>
</div>

<div id="outline-container-orgheadline24" class="outline-5">
<h5 id="orgheadline24">load と名前空間</h5>
<div class="outline-text-5" id="text-orgheadline24">
<p>
mod.rb をロードし，その後実行を続ける場合を考える
</p>

<ul class="org-ul">
<li>mod.rbには変数やクラスの定義がある．</li>

<li>load('mod.rb')を実行すると，実行後変数は消えるが，定数は残る．</li>

<li>load('mod.rb', true) とすると，無名モジュールを作成し，
そのスコープで mod.rb を実行する．定数も破棄される</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgheadline25" class="outline-4">
<h4 id="orgheadline25">オブジェクトとクラスのまとめ</h4>
<div class="outline-text-4" id="text-orgheadline25">
<p>
オブジェクトとは何か?
</p>
<ul class="org-ul">
<li>インスタンス変数の集り + クラスへのリンク</li>
</ul>

<p>
クラスとは何か？
</p>
<ul class="org-ul">
<li>Classクラスのインスタンス + インスタンスメソッド一覧 + スーパーク
ラスへのリンク</li>

<li>ClassクラスはModuleクラスのサブクラス</li>

<li>つまりクラスはモジュール</li>
</ul>

<p>
<a href="file://~suzuki/COMM/Prog/ruby/meta/object_model/private.rb">private.rb</a>
</p>
</div>

<div id="outline-container-orgheadline26" class="outline-5">
<h5 id="orgheadline26">もう一つの学習機会</h5>
<div class="outline-text-5" id="text-orgheadline26">
<p>
(({ class M; end })) =&gt; "M is not a class"
</p>

<p>
M という名前の衝突．一つはモジュール名，もう一つはクラス名．
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline28" class="outline-3">
<h3 id="orgheadline28"><span class="section-number-3">2.4</span> 引かれていない線</h3>
<div class="outline-text-3" id="text-2-4">
<p>
<a href="file://~suzuki/COMM/Prog/ruby/meta/object_model/quiz.rb">quiz.rb</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline38" class="outline-3">
<h3 id="orgheadline38"><span class="section-number-3">2.5</span> メソッドを呼び出すときに何が起きているの?</h3>
<div class="outline-text-3" id="text-2-5">
<p>
メソッド呼び出しを深く理解する
</p>
</div>

<div id="outline-container-orgheadline29" class="outline-4">
<h4 id="orgheadline29">メソッドを呼び出すこと</h4>
<div class="outline-text-4" id="text-orgheadline29">
<ul class="org-ul">
<li>メソッドを探す ( ((* メソッド探索 *)) )</li>
<li>メソッドを実行 ( ((* self *)) が必要)
<ul class="org-ul">
<li>self は実行の主体</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline30" class="outline-4">
<h4 id="orgheadline30">メソッド探索</h4>
<div class="outline-text-4" id="text-orgheadline30">
<p>
(現在実行の）オブジェクトのクラスを探しメソッドを見つける
</p>


<p>
((* レシーバ <b>)) と ((</b> 継承チェーン *))
</p>
</div>

<div id="outline-container-orgheadline31" class="outline-6">
<h6 id="orgheadline31">レシーバ</h6>
<div class="outline-text-6" id="text-orgheadline31">
<p>
呼び出すメソッドが属するオブジェクト
</p>
</div>
</div>

<div id="outline-container-orgheadline32" class="outline-6">
<h6 id="orgheadline32">継承チェーン</h6>
<div class="outline-text-6" id="text-orgheadline32">
<p>
<a href="file://~suzuki/COMM/Prog/ruby/meta/object_model/lookup.rb">lookup.rb</a>
</p>

<ul class="org-ul">
<li><p>
ruby 1.8
</p>
<pre class="example">
[MySubclass, MyClass, Object, Kernel]
</pre></li>

<li><p>
ruby 1.9~
</p>
<pre class="example">
[MySubclass, MyClass, Object, Kernel, BasicObject]
</pre></li>
</ul>

<p>
Kernel はモジュール 
</p>
</div>
</div>

<div id="outline-container-orgheadline33" class="outline-5">
<h5 id="orgheadline33">モジュールとメソッド探索</h5>
<div class="outline-text-5" id="text-orgheadline33">
<p>
<a href="file://~suzuki/COMM/Prog/ruby/meta/object_model/lookup_modules.rb">lookup_modules.rb</a>
</p>

<ul class="org-ul">
<li>include は継承に似ていて，</li>
<li>self クラスとsuperclass の間に入る</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline34" class="outline-5">
<h5 id="orgheadline34">Kernel</h5>
<div class="outline-text-5" id="text-orgheadline34">
<p>
<a href="file://~suzuki/COMM/Prog/ruby/meta/object_model/kernel.rb">kernel.rb</a>
</p>

<p>
(({ print })) は Kernel モジュールのプライベートインスタンスメソッ
ド
</p>
</div>

<div id="outline-container-orgheadline35" class="outline-6">
<h6 id="orgheadline35">RubyGems の例</h6>
<div class="outline-text-6" id="text-orgheadline35">
<div class="org-src-container">

<pre class="src src-ruby">require 'rubygems'
gem 'rails', '= 2.3.3'
</pre>
</div>

<div class="org-src-container">

<pre class="src src-ruby"># gems/rubygems-update-1.3.3/lib/rubygems.rb
module Kernel
  def gem(gem_name, *version_requirements)
  end
end
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline36" class="outline-4">
<h4 id="orgheadline36">メソッドの実行</h4>
<div class="outline-text-4" id="text-orgheadline36">
<p>
<a href="file://~suzuki/COMM/Prog/ruby/meta/object_model/self.rb">self.rb</a>
</p>

<ul class="org-ul">
<li>self カレントオブジェクト</li>
<li>self のコンテキストが実行の場</li>
<li>トップレベルコンテキスト main</li>
</ul>
</div>

<div id="outline-container-orgheadline37" class="outline-5">
<h5 id="orgheadline37">クラス定義とself</h5>
<div class="outline-text-5" id="text-orgheadline37">
<p>
クラスやモジュールの定義中，self は？
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline39" class="outline-3">
<h3 id="orgheadline39"><span class="section-number-3">2.6</span> オブジェクトとクラスのまとめ</h3>
<div class="outline-text-3" id="text-2-6">
<p>
オブジェクトとは何か?
</p>
<ul class="org-ul">
<li>インスタンス変数の集り + クラスへのリンク</li>
</ul>

<p>
クラスとは何か？
</p>
<ul class="org-ul">
<li>Classクラスのインスタンス + インスタンスメソッド一覧 + スーパーク
ラスへのリンク</li>

<li>ClassクラスはModuleクラスのサブクラス</li>

<li>つまりクラスはモジュール</li>
</ul>

<p>
<a href="file://~/COMM/Prog/ruby/meta/object_model/private.rb">private.rb</a>
\* メソッド
</p>
</div>
</div>

<div id="outline-container-orgheadline40" class="outline-3">
<h3 id="orgheadline40"><span class="section-number-3">2.7</span> 静的言語と動的言語，</h3>
<div class="outline-text-3" id="text-2-7">
<p>
静的言語
</p>

<ul class="org-ul">
<li>コンパイル時に，間違ったメソッドの使い方を指摘してくれる，かわり
に，</li>

<li>コンパイル時に持っていないメソッドは使えない．動的な拡張性や柔軟性
を欠く</li>
</ul>

<p>
rubyは動的．
</p>
</div>
</div>

<div id="outline-container-orgheadline44" class="outline-3">
<h3 id="orgheadline44"><span class="section-number-3">2.8</span> 重複問題</h3>
<div class="outline-text-3" id="text-2-8">
<ul class="org-ul">
<li>コンピュータの各部品とそのコストの一覧を作成するレポート機能</li>

<li>少しだけ違うよく似たコードが山のように存在する</li>
</ul>
</div>

<div id="outline-container-orgheadline41" class="outline-4">
<h4 id="orgheadline41">レガシーシステム DS</h4>
<div class="outline-text-4" id="text-orgheadline41">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/data_source.rb">computer/data_source.rb</a>
</p>

<p>
def get_#{objects}_#{properties}(id) の集り
</p>
</div>
</div>

<div id="outline-container-orgheadline42" class="outline-4">
<h4 id="orgheadline42">ダブル，トリプル，トラブル</h4>
<div class="outline-text-4" id="text-orgheadline42">
<p>
よく似たコードの羅列
</p>

<p>
DS クラスを Computer クラスのオブジェクトでラップする
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/boring.rb">computer/boring.rb</a>
</p>
<ul class="org-ul">
<li>異なるメソッド中の，よく似たコードの羅列</li>
</ul>
</div>

<div id="outline-container-orgheadline43" class="outline-5">
<h5 id="orgheadline43">重複コード排除のための二つの方針</h5>
<div class="outline-text-5" id="text-orgheadline43">
<ul class="org-ul">
<li>動的メソッド</li>
<li>method_missing()を使う</li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-orgheadline53" class="outline-3">
<h3 id="orgheadline53"><span class="section-number-3">2.9</span> 動的メソッドによる重複コードの排除</h3>
<div class="outline-text-3" id="text-2-9">
</div><div id="outline-container-orgheadline45" class="outline-4">
<h4 id="orgheadline45">メソッドを動的に呼び出す</h4>
<div class="outline-text-4" id="text-orgheadline45">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/methods/dynamic_call.rb">dynamic_call.rb</a>
</p>

<p>
Object#send() によるメソッド呼び出し
</p>

<ul class="org-ul">
<li><p>
obj.send(:my_method, 3)
</p>

<p>
メソッド名に対応するシンボル値と，引数を与えて，
obj.my_method(3) と同じ働きをする
</p>

<p>
<b>動的ディスパッチ</b> という
</p></li>
</ul>
</div>

<div id="outline-container-orgheadline46" class="outline-5">
<h5 id="orgheadline46">Camping の例</h5>
<div class="outline-text-5" id="text-orgheadline46">
<p>
<a href="https://ja.wikipedia.org/wiki/YAML">YAML</a> による属性値の設定
 admin : Bill
 title : Rubyland
 topic : Ruby and more
</p>

<p>
ユーザは好きな属性が使える
</p>
<ul class="org-ul">
<li>conf.admin = 'Bill' &#x2026; のようなコードをあらかじめ用意できない</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline47" class="outline-5">
<h5 id="orgheadline47">Test::Unit の例</h5>
<div class="outline-text-5" id="text-orgheadline47">
<p>
名前が test で始まるメソッドをテストメソッドとしている
</p>

<p>
method_names = public_instance_methods(true)
tests = method_names.delete_if { |method_name| method_name !~ <i>^test.</i>}
</p>

<p>
このtests配列のメソッドを，後で send を使って呼び出す
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline48" class="outline-4">
<h4 id="orgheadline48">メソッドを動的に定義する</h4>
<div class="outline-text-4" id="text-orgheadline48">
<p>
Module#define_method() でメソッドをその場で定義する
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/dynamic_definition.rb">dynamic_definitioon.rb</a>
</p>

<p>
<b>動的メソッド</b> と呼ぶ
</p>
</div>
</div>

<div id="outline-container-orgheadline49" class="outline-4">
<h4 id="orgheadline49">Computerクラスのリファクタリング</h4>
<div class="outline-text-4" id="text-orgheadline49">
<p>
もとのコード <a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/boring.rb">computer/boring.rb</a>  
</p>
</div>

<div id="outline-container-orgheadline50" class="outline-5">
<h5 id="orgheadline50">手順1 - 動的ディスパッチャの追加</h5>
<div class="outline-text-5" id="text-orgheadline50">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/send.rb">computer/send.rb</a>
component メソッドが動的ディスパッチャ
</p>
</div>
</div>


<div id="outline-container-orgheadline51" class="outline-5">
<h5 id="orgheadline51">手順2 - メソッドを動的に生成する</h5>
<div class="outline-text-5" id="text-orgheadline51">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/dynamic.rb">computer/dynamic.rb</a>
</p>

<p>
def self.define_component(name) &#x2026; 
</p>
<ul class="org-ul">
<li>クラスメソッド define_component の定義</li>
<li>define_component中 name の値の名前を持つメソッドを生成する</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline52" class="outline-5">
<h5 id="orgheadline52">手順3 - コードにイントロスペクションをふりかける</h5>
<div class="outline-text-5" id="text-orgheadline52">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/more_dynamic.rb">computer/more_dynamic.rb</a>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline68" class="outline-3">
<h3 id="orgheadline68"><span class="section-number-3">2.10</span> method_missing()による重複コードの排除</h3>
<div class="outline-text-3" id="text-2-10">
<p>
ruby では存在しないメソッドも呼び出せる
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/method_missing.rb">method_missing.rb</a> 存在しないメソッド呼び出しとエラー
</p>

<p>
メソッド探索の仕組み  
</p>
<ul class="org-ul">
<li>レシーバの継承チェーン上のインスタンスメソッドを探す</li>
<li>なければ，レシーバのmethod_missing()メソッドを呼び出す
<ul class="org-ul">
<li>method_missing()はBasicObjectのインスタンスメソッド (ruby 1.9)</li>
</ul></li>
</ul>
</div>

<div id="outline-container-orgheadline54" class="outline-4">
<h4 id="orgheadline54">method_missing の <b>オーバーライド</b></h4>
<div class="outline-text-4" id="text-orgheadline54">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/more_method_missing.rb">more_method_missing.rb</a>
</p>

<p>
((<b>オーバーライド</b>))は，継承チェーン上に存在するメソッドを，
再定義すること
</p>

<p>
method_missing をオーバーライドして，
実際には存在しないメソッドを呼び出せる
</p>
</div>
</div>

<div id="outline-container-orgheadline55" class="outline-4">
<h4 id="orgheadline55">ghost method</h4>
<div class="outline-text-4" id="text-orgheadline55">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/ruport_example.rb">ruport_example.rb</a>
</p>
</div>

<div id="outline-container-orgheadline56" class="outline-5">
<h5 id="orgheadline56">openstruct</h5>
<div class="outline-text-5" id="text-orgheadline56">
<div class="org-src-container">

<pre class="src src-ruby">require 'ostruct'
icecream = OpenStruct.new
icecream.flavor = "ストロベリー"
icecream.flavor
</pre>
</div>

<p>
属性メソッドがゴーストメソッド
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/my_ostruct.rb">my_ostruct.rb</a>
</p>
</div>
</div>
</div>


<div id="outline-container-orgheadline57" class="outline-4">
<h4 id="orgheadline57">動的プロキシ</h4>
<div class="outline-text-4" id="text-orgheadline57">
<ul class="org-ul">
<li>ゴーストメソッドは，ラッパーでよく使われる</li>
<li>メソッド呼び出しをmethod_missing()に集中させる
ラップしたオブジェクトに投げる</li>
</ul>
</div>

<div id="outline-container-orgheadline58" class="outline-5">
<h5 id="orgheadline58">Flicrの例</h5>
<div class="outline-text-5" id="text-orgheadline58">
<div class="org-src-container">

<pre class="src src-ruby">require 'flickr'
flickr = Flickr.new(YOUR_API_KEY)
xml = flickr.tags_getListUser('user_id' =&gt; '59542755@N00')
tags = xml['who']['tags']['tag'] 
tags.grep /rails/
</pre>
</div>

<p>
flickr はAPIが拡張された場合でも対応可能
</p>

<div class="org-src-container">

<pre class="src src-ruby">class Flickr
  def requrest(method, *params)
  response = XmlSimple.xml_in(http_get(request_url(method,
		  params)), {'ForceArray' =&gt; false})
  raise response['err']['msg'] if response['stat'] != 'ok'
  response
end

def method_missing(method_id, *params)
  request(method_id2name.gsub(/_/, '.'), params[0])
end
...
</pre>
</div>

<p>
Flickr#method_missing() は名前を変更して，Flickr#request()に委譲
</p>

<p>
<b>動的プロキシ</b>
</p>
<ul class="org-ul">
<li>オブジェクトがゴーストメソッドを受け取り，</li>
<li>何らかの処理をして，</li>
<li>他のオブジェクトに転送する</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline59" class="outline-5">
<h5 id="orgheadline59">委譲 (コラム)</h5>
<div class="outline-text-5" id="text-orgheadline59">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/delegator.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/delegator.rb</a>
</p>
</div>

<div id="outline-container-orgheadline60" class="outline-6">
<h6 id="orgheadline60">DelegateClass() は，ミミックメソッド</h6>
<div class="outline-text-6" id="text-orgheadline60">
<ul class="org-ul">
<li>未定義のメソッド呼び出しを，</li>
<li>与えられたクラス（のオブジェクト）に委譲する</li>
<li>クラスを返す</li>
</ul>

<div class="org-src-container">

<pre class="src src-ruby">frank = Assistant.new("Frank")
anne = Manager.new(frank)
anne.attend_meeting
anne.read_email
anne.check_schedule
</pre>
</div>

<p>
anne は理解できないメッセージをすべて frank に転送している
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline61" class="outline-4">
<h4 id="orgheadline61">Computerクラスのリファクタリング</h4>
<div class="outline-text-4" id="text-orgheadline61">
<p>
元のコード<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/boring.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/boring.rb</a>
</p>

<p>
Computerクラスは動的プロキシになる
</p>
</div>

<div id="outline-container-orgheadline62" class="outline-6">
<h6 id="orgheadline62">リファクタリングするぜ</h6>
<div class="outline-text-6" id="text-orgheadline62">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/proxy.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/proxy.rb</a>
</p>

<div class="org-src-container">

<pre class="src src-ruby">my_computer = Computer.new(42, DS.new)
my_computer.cpu
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline63" class="outline-6">
<h6 id="orgheadline63">resopond_to?()のオーバーライド</h6>
<div class="outline-text-6" id="text-orgheadline63">
<p>
(({mouse()}))) は本物のメソッドではない．
</p>
<ul class="org-ul">
<li>ドキュメントには現れない</li>
<li>(({Object#methods}))にも登場しない</li>
<li>(({Computer}))クラスにゴーストメソッドはあるかと聞いても嘘を
つく</li>
</ul>
<div class="org-src-container">

<pre class="src src-ruby">cmp = Computer.new(0, DS.new)
cmp.respond_to?(:mouse)
</pre>
</div>
</div>

<div id="outline-container-orgheadline64" class="outline-7">
<h7 id="orgheadline64">(({respond_to?()}))のオーバーライド</h7>
<div class="outline-text-7" id="text-orgheadline64">
<div class="org-src-container">

<pre class="src src-ruby">class Computer
  def respond_to?(name)
    @data_source.respond_to?("get_#{method}_info") || super
  end
end
</pre>
</div>

<p>
superを呼び出すのは他のメソッドの面倒を見てもらうため
</p>
</div>
</div>

<div id="outline-container-orgheadline65" class="outline-7">
<h7 id="orgheadline65">(({Object#methods()}))もオーバーライド？</h7>
<div class="outline-text-7" id="text-orgheadline65">
<p>
？
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline66" class="outline-5">
<h5 id="orgheadline66">リファクタリングのまとめ</h5>
<div class="outline-text-5" id="text-orgheadline66">
<ul class="org-ul">
<li>動的メソッドと動的ディスパッチ
DSのラッパーとして，イントロスペクションを使う</li>
<li>レガシーシステムに委譲</li>
</ul>
</div>

<div id="outline-container-orgheadline67" class="outline-6">
<h6 id="orgheadline67">const_missing() (コラム)</h6>
<div class="outline-text-6" id="text-orgheadline67">
<p>
Module#const_missing() 存在しない定数を参照したとき呼ばれる
任意のネームスペースに定義できる
</p>

<div class="org-src-container">

<pre class="src src-ruby">def Object.const_missing(name)
  name.to_s.downcase.gsub(/_/, ' ')
end
</pre>
</div>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgheadline69" class="outline-3">
<h3 id="orgheadline69"><span class="section-number-3">2.11</span> クイズ: バグ退治</h3>
<div class="outline-text-3" id="text-2-11">
<p>
method_missing のバグは潰しにくい
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/bug_hunt.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/bug_hunt.rb</a>
</p>

<p>
ブロック局所変数 number のスコープ
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/bug_hunt_solution.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/bug_hunt_solution.rb</a>
[bug_hunt_solution.rb]
</p>
</div>
</div>

<div id="outline-container-orgheadline77" class="outline-3">
<h3 id="orgheadline77"><span class="section-number-3">2.12</span> もっと method_missing()</h3>
<div class="outline-text-3" id="text-2-12">
</div><div id="outline-container-orgheadline70" class="outline-4">
<h4 id="orgheadline70">メソッド名が衝突したら</h4>
<div class="outline-text-4" id="text-orgheadline70">
<pre class="example">
my_computer = Computer.new(42, DS.new)
my_computer.display # -&gt; nil
</pre>

<p>
Computer#display()が nil を返すわけ
</p>

<pre class="example">
Object.instance_methods.grep /^d/
</pre>

<p>
Object#displayがみつかるため，method_missing にならない
</p>

<p>
動的プロキシでも同じ問題が起こる
</p>

<p>
ゴーストメソッド名と継承メソッド名の衝突が原因
</p>

<p>
継承メソッドを消す
</p>

<ul class="org-ul">
<li>(({Module#undef_method()})) は全てのメソッドを消す</li>
<li>(({Module#remove_method()})) レシーバのメソッドのみ削除</li>
</ul>
</div>

<div id="outline-container-orgheadline71" class="outline-5">
<h5 id="orgheadline71">パフォーマンスの不安</h5>
<div class="outline-text-5" id="text-orgheadline71">
<p>
ゴーストメソッドは通常のメソッドより(2倍)遅い
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/methods_benchmark.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/methods_benchmark.rb</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline72" class="outline-5">
<h5 id="orgheadline72">Builderの例</h5>
<div class="outline-text-5" id="text-orgheadline72">
<p>
BuilderはXML生成ライブラリ
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/builder_example.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/builder_example.rb</a>
</p>

<div class="org-src-container">

<pre class="src src-ruby">class BlankSlate
  def self.hide(name)
    if instance_methos.include?(name.to_s) and
       name !~ /^(__|instance_eval)/
      @hidden_methods  !!= {}
      @hidden_methods[name.to_sym] = instance_metho(name)
      undef_method name
    end
  end
end
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline73" class="outline-5">
<h5 id="orgheadline73">予約済メソッド</h5>
<div class="outline-text-5" id="text-orgheadline73">
<p>
Objectのメソッドには Ruby が内部的に使うものがある．再定義すると
おかしくなる．
<span class="underline"><span class="underline">send()</span></span>, __id__()
</p>
</div>
</div>

<div id="outline-container-orgheadline74" class="outline-5">
<h5 id="orgheadline74">コンピュータクラスの修正</h5>
<div class="outline-text-5" id="text-orgheadline74">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/blank.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/blank.rb</a>
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/more_blank.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/more_blank.rb</a>
</p>
</div>
</div>


<div id="outline-container-orgheadline75" class="outline-5">
<h5 id="orgheadline75">BasicObject</h5>
<div class="outline-text-5" id="text-orgheadline75">
<p>
Ruby1.9から <b>ブランクスレート</b> が言語に組み込まれた
</p>

<p>
irb19で
</p>
<pre class="example">
p BasicObject.instance_methods
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline76" class="outline-4">
<h4 id="orgheadline76">まとめ</h4>
<div class="outline-text-4" id="text-orgheadline76">
<p>
Computerクラスの重複をなくすリファクタリング
<b>動的メソッド</b>
<b>動的ディスパッチ</b> 
<b>動的プロキシ</b>
<b>ブランクスレート</b>
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/more_dynamic.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/more_dynamic.rb</a>
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/final.rb">file://~suzuki/COMM/Lects/meta-ruby/code/methods/computer/final.rb</a>
</p>
</div>
</div>
</div>
</div>





<div id="outline-container-orgheadline79" class="outline-2">
<h2 id="orgheadline79"><span class="section-number-2">3</span> リソース</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://github.com/hamamatsu-rb/hamamatsu-rb.github.com/wiki/%E3%83%A1%E3%82%BF%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0ruby%E8%AA%AD%E6%9B%B8%E4%BC%9A">メタプログラミングruby読書会</a>
<a href="https://pragprog.com/titles/ppmetr/source_code">source code</a>
</p>
</div>
</div>
<div id="outline-container-orgheadline117" class="outline-2">
<h2 id="orgheadline117"><span class="section-number-2">4</span> クラス定義</h2>
<div class="outline-text-2" id="text-4">
<p>
((:class:)) キーワードは，クラスオブジェクト(のコンテキスト)で
((:end:)) までのブロックを実行すること
</p>

<p>
((:特異クラス:)) はオブジェクトや(オブジェクトとしての)クラスを拡張する
</p>

<p>
class の中で特異メソッド（クラスメソッド) が使え、クラス定義中に下記
のことが実現できる:
</p>

<ul class="org-ul">
<li>クラスマクロ
動的なメソッドの生成など</li>

<li>アラウンドエイリアス
メソッド名の付け替えとラップなど</li>
</ul>
</div>

<div id="outline-container-orgheadline80" class="outline-3">
<h3 id="orgheadline80"><span class="section-number-3">4.1</span> クラスに関する説明のつかない事</h3>
<div class="outline-text-3" id="text-4-1">
<p>
例えば，File クラス
</p>

<ul class="org-ul">
<li>File はクラスそれともオブジェクト?</li>
<li>File.open("hoge")は誰がどこで実行する？</li>
<li>File.new と インスタンスメソッドの initialize の関係は？</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline93" class="outline-3">
<h3 id="orgheadline93"><span class="section-number-3">4.2</span> クラス定義のわかりやすい説明</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-orgheadline81" class="outline-4">
<h4 id="orgheadline81">クラス定義の中身</h4>
<div class="outline-text-4" id="text-orgheadline81">
<p>
class 式は，クラス定義コンテキストで式の中身を実行する
</p>

<pre class="example">
class MyClass
  puts 'Hello!'
end
</pre>

<p>
class式は定義/変更したクラスを返す
</p>

<pre class="example">
result = class MyClass
  self
end
result # =&gt; MyClass
</pre>

<p>
クラス定義コンテキストでは self は定義中のクラス自身
</p>
</div>
</div>

<div id="outline-container-orgheadline86" class="outline-4">
<h4 id="orgheadline86">カレントクラス</h4>
<div class="outline-text-4" id="text-orgheadline86">
</div><div id="outline-container-orgheadline82" class="outline-5">
<h5 id="orgheadline82">Rubyプログラムのコンテキスト(?)</h5>
<div class="outline-text-5" id="text-orgheadline82">
<ul class="org-ul">
<li>カレントオブジェクト self,</li>
<li>カレントクラス (あるいはモジュール)</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline83" class="outline-5">
<h5 id="orgheadline83">カレントクラスを参照する方法</h5>
<div class="outline-text-5" id="text-orgheadline83">
<p>
カレントクラスを変更する方法
</p>

<pre class="example">
class MyClass
  def my_method
  end
end
</pre>

<p>
class式は，クラス名がわからないと無力
</p>
</div>
</div>

<div id="outline-container-orgheadline84" class="outline-5">
<h5 id="orgheadline84">カレントクラスと特別な場合</h5>
<div class="outline-text-5" id="text-orgheadline84">
<p>
<a href="file:///users/home/masayuki/Lects/meta-ruby/code/class_definitions/current_class.rb">file:///users/home/masayuki/Lects/meta-ruby/code/class_definitions/current_class.rb</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline85" class="outline-5">
<h5 id="orgheadline85">class_eval()</h5>
<div class="outline-text-5" id="text-orgheadline85">
<p>
Module#class_evalは，既存のクラスのコンテキストでブロックを評価
する
</p>

<p>
<a href="file:///users/home/masayuki/Lects/meta-ruby/code/class_definitions/class_eval.rb">file:///users/home/masayuki/Lects/meta-ruby/code/class_definitions/class_eval.rb</a>
</p>

<pre class="example">
def add_method_to(a_class)
  a_class.class_eval do
    def m; 'Hello!'; end
  end
end
</pre>

<pre class="example">
add_method_to String
"abc".m # =&gt; 'Hello!'
</pre>

<p>
コンテキストの変化
</p>
<ul class="org-ul">
<li>class_eval は self とカレントクラスの値が変る</li>
<li>instance_eval は self の値だけが変る</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orgheadline87" class="outline-4">
<h4 id="orgheadline87">カレントクラスのまとめ</h4>
<div class="outline-text-4" id="text-orgheadline87">
<ul class="org-ul">
<li>クラス定義の中では，カレントオブジェクト self は，定義されたク
ラスである．</li>
<li>Rubyインタプリタは，常に，カレントクラスの参照を追跡している
def で定義された全てのメソッドは，カレントクラスのインスタンス
メソッドになる</li>
<li>クラス定義のなかでは，カレントクラスは self と同じ</li>
<li>クラスへの参照をもっていれば， class_eval でオープンできる</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline88" class="outline-4">
<h4 id="orgheadline88">クラスインスタンス変数</h4>
<div class="outline-text-4" id="text-orgheadline88">
<p>
Rubyインタプリタは，全てのインスタンス変数はカレントオブジェクト
self に属していると思っている．
</p>

<p>
<a href="file:///users/home/masayuki/Lects/meta-ruby/code/class_definitions/class_eval.rb">file:///users/home/masayuki/Lects/meta-ruby/code/class_definitions/class_eval.rb</a>
</p>

<p>
@my_var はMyClassオブジェクトに属している
</p>

<pre class="example">
class MyClass
  @my_var = 1
  def self.read; @my_var: end
  def write; @my_var = 2; end
  def read; @my_var; end
end
obj = MyClass.new
obj.write
obj.read   # =&gt; 2
MyClass.read # =&gt; 1 # self.read 
</pre>
</div>
</div>

<div id="outline-container-orgheadline89" class="outline-4">
<h4 id="orgheadline89">クラス変数</h4>
<div class="outline-text-4" id="text-orgheadline89">
<pre class="example">
class C; @@v = 1; end
class D &lt; C; def my_method; @@v; end; end
D.new.my_method # =&gt;  1
</pre>

<p>
@@v は継承されている！
</p>

<pre class="example">
@@v = 1
class MyClass; @@v = 2; end
@@v # =&gt; 2
</pre>

<p>
これはrubyの酷いくせ
クラス変数は，クラス階層に属している
上の例では，@@v は Object クラスに属している
</p>
</div>
</div>

<div id="outline-container-orgheadline90" class="outline-4">
<h4 id="orgheadline90">Bookwormの作業再び</h4>
<div class="outline-text-4" id="text-orgheadline90">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/bookworm_classvars.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/bookworm_classvars.rb</a>
</p>
</div>

<div id="outline-container-orgheadline91" class="outline-5">
<h5 id="orgheadline91">Loan#to_s()のユニットテストの問題点</h5>
<div class="outline-text-5" id="text-orgheadline91">
<p>
期待すべき結果が日付や時刻に依存するため，テストが書けない
</p>
</div>
</div>

<div id="outline-container-orgheadline92" class="outline-5">
<h5 id="orgheadline92">解決方法</h5>
<div class="outline-text-5" id="text-orgheadline92">
<p>
本来の日付や時刻を作成するクラスを置き換えて、
テスト用の日付や時刻を切り替えて使えるようにする．
</p>

<p>
クラスインスタンス変数 @time_class の有無により，
Time クラスを使うか, FakeTime クラスを使うか切り替える．
</p>

<p>
切り替えは、instance_eval でクラスインスタンス変数を切り替えるこ
とで行う．
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgheadline95" class="outline-3">
<h3 id="orgheadline95"><span class="section-number-3">4.3</span> クイズ: クラスのタブー</h3>
<div class="outline-text-3" id="text-4-3">
<p>
(({class})) を使わずに 下記 MyClass 
</p>

<pre class="example">
class MyClass &lt; Array
  def my_method
    'Hello!'
  end
end
</pre>

<p>
を定義するruby プログラムを書くこと
</p>
</div>

<div id="outline-container-orgheadline94" class="outline-4">
<h4 id="orgheadline94">クイズの答え</h4>
<div class="outline-text-4" id="text-orgheadline94">
<pre class="example">
c = Class.new(Array) do
  def my_method 
    'Hello'
  end
end
MyClass = c
</pre>

<p>
このクラスには最初定数名がない! 無名クラスだ．
</p>

<p>
Ruby 処理系は、MyClass へ 無名クラスを代入するときに、特別なこと
をする。無名クラスの名前付け，すなわちクラス値から定数名への参照
を持つこと，をおこなう。
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline100" class="outline-3">
<h3 id="orgheadline100"><span class="section-number-3">4.4</span> 特異メソッド</h3>
<div class="outline-text-3" id="text-4-4">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/paragraph.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/paragraph.rb</a>
</p>

<p>
Paragraph クラスは String クラスのごく僅かな拡張で，
その拡張 (titleメソッド)が使われる場所もごく限られている
</p>
</div>

<div id="outline-container-orgheadline96" class="outline-4">
<h4 id="orgheadline96">特異メソッドの導入</h4>
<div class="outline-text-4" id="text-orgheadline96">
<p>
特異メソッドの導入 :: 特定のオブジェクトに定義されたメソッド
</p>

<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/singleton_methods.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/singleton_methods.rb</a>
</p>
</div>


<div id="outline-container-orgheadline97" class="outline-5">
<h5 id="orgheadline97">特異メソッドの実践</h5>
<div class="outline-text-5" id="text-orgheadline97">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/paragraph.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/class_definitions/paragraph.rb</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline98" class="outline-4">
<h4 id="orgheadline98">クラスメソッドの真実</h4>
<div class="outline-text-4" id="text-orgheadline98">
<p>
「クラスもオブジェクト」だった．
</p>

<p>
実は，クラスに対するメソッドの呼び出しは，
オブジェクトに対するメソッドの呼び出しと，同じ仕組みだった．
</p>

<p>
それはクラス・オブジェクトの特異メソッドだ
</p>

<pre class="example">
class MyClass
  def self.s_method
  end
end
</pre>

<p>
s_method は，オブジェクト MyClass だけに定義されたメソッド．
</p>
</div>
</div>

<div id="outline-container-orgheadline99" class="outline-4">
<h4 id="orgheadline99">クラスマクロ</h4>
<div class="outline-text-4" id="text-orgheadline99">
<p>
attr_reader, attr_writer, attr_accessor などは，
キーワードのように見えるが，
<b>単なるクラスメソッド</b> である
</p>

<p>
クラスメソッドは，クラス定義中に，
クラスコンテキストで実行できる 
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline112" class="outline-3">
<h3 id="orgheadline112"><span class="section-number-3">4.5</span> 特異クラス</h3>
<div class="outline-text-3" id="text-4-5">
<p>
オブジェクトモデルの完結
</p>

<p>
(<b>s</b>) クラスメソッドや特異メソッドが，単なるメソッドにすぎなくなるためのモデル
</p>
</div>

<div id="outline-container-orgheadline101" class="outline-4">
<h4 id="orgheadline101">特異メソッドの謎</h4>
<div class="outline-text-4" id="text-orgheadline101">
<pre class="example">
def obj.my_singleton_method; 'where is this' end
obj.my_singleton_method =&gt; 'where is this'
</pre>

<p>
obj だけに存在する my_singleton_method はどこにある？
</p>

<p>
=&gt; obj &#x2013; (my_singleton_method) &#x2013; class ( &#x2026; )
</p>
</div>
</div>

<div id="outline-container-orgheadline102" class="outline-4">
<h4 id="orgheadline102">特異クラスの出現</h4>
<div class="outline-text-4" id="text-orgheadline102">
<p>
<b>特異クラス</b> はオブジェクトの特異メソッドが住む場所
</p>

<p>
「特異クラスはオブジェクトではない」は間違い (<b>s</b>)
</p>
</div>

<div id="outline-container-orgheadline103" class="outline-5">
<h5 id="orgheadline103">特異クラスを定義する特別な構文</h5>
<div class="outline-text-5" id="text-orgheadline103">
<pre class="example">
class &lt;&lt; an_object; end
</pre>
</div>
</div>

<div id="outline-container-orgheadline104" class="outline-5">
<h5 id="orgheadline104">特異クラスへの参照を得て特異クラスのクラスを見る</h5>
<div class="outline-text-5" id="text-orgheadline104">
<pre class="example">
obj = Object.new
eigenclass = class &lt;&lt; obj
  self
end
eigenclass.class # =&gt; Class
</pre>
</div>
</div>

<div id="outline-container-orgheadline105" class="outline-5">
<h5 id="orgheadline105">特異クラスに特異メソッドが住んでいる</h5>
<div class="outline-text-5" id="text-orgheadline105">
<pre class="example">
def obj.my_singleton_method; end
eigenclass.instance_methods.grep(/my_/)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline111" class="outline-4">
<h4 id="orgheadline111">メソッド探索再び</h4>
<div class="outline-text-4" id="text-orgheadline111">
</div><div id="outline-container-orgheadline106" class="outline-5">
<h5 id="orgheadline106">オブジェクトモデルを調べる実践的な例</h5>
<div class="outline-text-5" id="text-orgheadline106">
<pre class="example">
class C
  def a_method
    'C#a_method()'
  end
end
</pre>

<pre class="example">
class D &lt; C; end
</pre>

<pre class="example">
obj = D.new
obj.a_method
</pre>

<pre class="example">
class &lt;&lt; obj
  def a_singleton_method
    'obj#a_singleton_method()'
  end
end
</pre>
</div>
</div>

<div id="outline-container-orgheadline107" class="outline-5">
<h5 id="orgheadline107">特異クラスのスーパークラスは？</h5>
<div class="outline-text-5" id="text-orgheadline107">
<pre class="example">
eigenclass.superclass # =&gt; D
</pre>

<p>
#obj.class == obj.class
</p>

<pre class="example">
</pre>
</div>
</div>

<div id="outline-container-orgheadline108" class="outline-5">
<h5 id="orgheadline108">特異クラスの特異クラス</h5>
<div class="outline-text-5" id="text-orgheadline108">
<pre class="example">
class &lt;&lt; "abc"
  class &lt;&lt; self
    self 
  end
end
</pre>

<p>
特異クラスはクラスでありオブジェクトでもある。
特異クラスの特異クラスも同様。
</p>
</div>
</div>


<div id="outline-container-orgheadline109" class="outline-5">
<h5 id="orgheadline109">特異クラスと継承</h5>
<div class="outline-text-5" id="text-orgheadline109">
<p>
オブジェクトの特異クラスを返すヘルパーメソッド (({eigenclass}))
</p>

<pre class="example">
class Object
  def eigenclass
    class &lt;&lt; self; self; end
  end
end
</pre>

<pre class="example">
class C
 def a_method
  'C#a_method()'
 end
end
</pre>

<pre class="example">
class D &lt; C; end
</pre>

<pre class="example">
class C
 class &lt;&lt; self
   def a_class_method
     'C.a_class_method()'
   end
 end
end
</pre>

<pre class="example">
C.eigenclass # =&gt; #&lt;Class:C&gt;
D.eigenclass # =&gt; #&lt;Class:D&gt;
D.eigenclass.superclass # =&gt; #&lt;Class:C&gt;
C.eigenclass.superclass # =&gt; #&lt;Class:Object&gt;
</pre>
</div>
</div>

<div id="outline-container-orgheadline110" class="outline-5">
<h5 id="orgheadline110">大統一理論</h5>
<div class="outline-text-5" id="text-orgheadline110">
<p>
Rubyのオブジェクトモデルの７つのルール
</p>

<ol class="org-ol">
<li>オブジェクトは１種類しかない。それが通常のオブジェクト化かモ
ジュールになる。</li>

<li>モジュールは１種類しかない。それが通常のモジュール、クラス、特
異クラス、プロキシクラスのいずれかになる。</li>

<li>メソッドは１種類しかない。メソッドはモジュール（クラス）に住んでいる。</li>

<li>すべてのオブジェクトは「本物のクラス」を持つ。それは特異クラス
か通常のクラスである。</li>

<li>すべてのクラスはスーパークラスを持っている。ただしBasicObject
にはスーパークラスはない。</li>

<li><p>
オブジェクトの特異クラスのスーパークラスは、オブジェクトのク
ラスである。
</p>

<p>
クラスの特異クラスのスーパークラスは、クラスのスーパークラスの特異クラス。
</p></li>

<li>メソッドを呼び出すとき、Ruby はレシーバの本物のクラスに向かっ
て、「右へ」進み、継承チェーンを「上へ」進む。</li>
</ol>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline114" class="outline-3">
<h3 id="orgheadline114"><span class="section-number-3">4.6</span> クイズ: モジュールの不具合</h3>
<div class="outline-text-3" id="text-4-6">
<p>
モジュールを include すると、モジュールのインスタンスメソッドは手に
入るが、モジュールのクラスメソッドは手に入らない。
</p>

<pre class="example">
module MyModule
 def my_method; 'hello'; end
end
</pre>

<pre class="example">
class MyClass
 class &lt;&lt; self
  include MyModule
 end
end
</pre>

<p>
クラスメソッドの住処である特異クラスで include すればよい。
</p>

<p>
クラスの特異クラスにメソッドを定義することを <b>クラス拡張</b> と呼ぶ
</p>

<p>
オブジェクトの特異クラスにメソッドを定義することを <b>オブジェクト拡張</b> と呼ぶ
</p>
</div>

<div id="outline-container-orgheadline113" class="outline-4">
<h4 id="orgheadline113">Object#extend</h4>
<div class="outline-text-4" id="text-orgheadline113">
<pre class="example">
obj.extend MyModule
</pre>

<pre class="example">
class MyClass
 extend MyModule
end
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline115" class="outline-3">
<h3 id="orgheadline115"><span class="section-number-3">4.7</span> エイリアス</h3>
<div class="outline-text-3" id="text-4-7">
<p>
省略
</p>
</div>
</div>

<div id="outline-container-orgheadline116" class="outline-3">
<h3 id="orgheadline116"><span class="section-number-3">4.8</span> クイズ: 壊れた計算</h3>
<div class="outline-text-3" id="text-4-8">
<pre class="example">
1+1 # =&gt; 3
</pre>

<p>
となるように Fixnum クラスの + メソッドを書き換える
</p>

<pre class="example">
class Fixnum
 alias :old_plus, :+
 def +(value)
  self.old_plus(value).old_plus(1)
 end
end
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline163" class="outline-2">
<h2 id="orgheadline163"><span class="section-number-2">5</span> ブロック</h2>
<div class="outline-text-2" id="text-5">
<p>
この章で理解すべきこと
</p>
<ul class="org-ul">
<li>スコープ</li>
<li>クロージャ</li>
<li>クロージャによるスコープの操作</li>
<li>呼び出し可能オブジェクトへの変換</li>
</ul>
</div>

<div id="outline-container-orgheadline121" class="outline-3">
<h3 id="orgheadline121"><span class="section-number-3">5.1</span> ブロックの基本</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">

<pre class="src src-ruby">def a_method(a, b)
  if block_given?
    a + yield(a, b)
  else
    a
  end
end
y=10
a_method(1,2) do |x| x+y end
</pre>
</div>
</div>

<div id="outline-container-orgheadline118" class="outline-4">
<h4 id="orgheadline118">ブロックの作成</h4>
<div class="outline-text-4" id="text-orgheadline118">
<ul class="org-ul">
<li>do &#x2026; end が block</li>
<li>メソッド呼び出しの時のみ
<ul class="org-ul">
<li>(<b>s</b>) class, def でも作れる</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline119" class="outline-4">
<h4 id="orgheadline119">ブロックが与えられているか？</h4>
<div class="outline-text-4" id="text-orgheadline119">
<ul class="org-ul">
<li>block_given? で調べられる</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline120" class="outline-4">
<h4 id="orgheadline120">ブロックの呼び出し</h4>
<div class="outline-text-4" id="text-orgheadline120">
<ul class="org-ul">
<li>呼ばれたメソッド側で yield により呼び出せる</li>
<li>しかし，block は，block が作られた*環境*で実行される</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgheadline125" class="outline-3">
<h3 id="orgheadline125"><span class="section-number-3">5.2</span> クイズ: Ruby#</h3>
<div class="outline-text-3" id="text-5-2">
</div><div id="outline-container-orgheadline122" class="outline-4">
<h4 id="orgheadline122">using</h4>
<div class="outline-text-4" id="text-orgheadline122">
<p>
リソースの確保，コードの実行，リソースの開放を記述。コードの実行中に例
外が発生しても，確実にリソースを開放する。
</p>
</div>
</div>

<div id="outline-container-orgheadline123" class="outline-4">
<h4 id="orgheadline123">using のテスト</h4>
<div class="outline-text-4" id="text-orgheadline123">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/using_test.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/using_test.rb</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline124" class="outline-4">
<h4 id="orgheadline124">using の実装</h4>
<div class="outline-text-4" id="text-orgheadline124">
<pre class="example">
module Kernel
 def using(resource)
   begin
     yield
   ensure
     resource.disclose
   end
 end
end
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline136" class="outline-3">
<h3 id="orgheadline136"><span class="section-number-3">5.3</span> クロージャ</h3>
<div class="outline-text-3" id="text-5-3">
<p>
変数のスコープを超える方法を学ぼう
</p>
</div>

<div id="outline-container-orgheadline126" class="outline-4">
<h4 id="orgheadline126">コードの実行</h4>
<div class="outline-text-4" id="text-orgheadline126">
<ul class="org-ul">
<li>ブロックはコード</li>
<li>*self*が実行の主体 (場)</li>
<li>クロージャ = コード + <b>束縛</b> (局所変数，インスタンス変数，&#x2026; )</li>
</ul>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/closure.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/closure.rb</a>
</p>

<p>
ブロックが生まれるとき，自身が生まれた環境を閉じ込めた ((<b>クロージャ</b>))
となる
</p>

<p>
クロージャが実行される時は，その環境で実行される
</p>
<ul class="org-ul">
<li>定数はselfのクラスから辿れる</li>
<li>インスタンス変数、特異メソッドには self から辿れる</li>
</ul>
</div>

<div id="outline-container-orgheadline127" class="outline-5">
<h5 id="orgheadline127">ブロックローカル変数</h5>
<div class="outline-text-5" id="text-orgheadline127">
<pre class="example">
def my_method
  yield
end

top_level_variable = 1
my_method do 
  top_level_variable += 1
  local_to_block = 1
end
top_level_variable
local_to_block
</pre>

<p>
top_level_variable は block のネスティング が行われ, 
外側のブロックのローカル変数を参照していることを示している．
</p>

<p>
local_to_block は，block の中で生まれたが，
block の実行終了とともに消滅した．
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline128" class="outline-4">
<h4 id="orgheadline128">スコープ</h4>
<div class="outline-text-4" id="text-orgheadline128">
<ul class="org-ul">
<li>束縛</li>
<li>self インスタンス変数，メソッド(in self.class)</li>
<li>定数の木</li>
<li>グローバル変数</li>
</ul>
</div>

<div id="outline-container-orgheadline129" class="outline-5">
<h5 id="orgheadline129">スコープの変更</h5>
<div class="outline-text-5" id="text-orgheadline129">
<p>
束縛を Kernel#local_variables() メソッドで追跡
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/scopes.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/scopes.rb</a>
</p>

<ul class="org-ul">
<li>トップレベル スコープ</li>
<li>MyClass 定義のトップレベル スコープ</li>
<li>メソッドの中のスコープ
メソッドのローカル変数，インスタンス変数，定数</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline130" class="outline-5">
<h5 id="orgheadline130">((<b>スコープゲート</b>))</h5>
<div class="outline-text-5" id="text-orgheadline130">
<p>
プログラムが新しいスコープを開く箇所
</p>
<ul class="org-ul">
<li>クラス定義 (({class}))</li>
<li>モジュール定義 (({module}))</li>
<li>メソッド呼び出し (({def}))</li>
</ul>

<div class="org-src-container">

<pre class="src src-ruby">v1 = 1
class MyClass        # クラスの入り口
  v2 = 2
  local_variables    # =&gt; ["v2"]
  def my_method      # メソッドの入り口
    v3 = 3
    local_variables  
  end                # メソッドの出口
  local_variables    # =&gt; ["v2"]
end　　              # クラスの出口
obj = MyClass.new
obj.my_method        # =&gt; ["v3"]
obj.my_method        # =&gt; ["v3"]
local_variables      # =&gt; ["v1", "obj"]
</pre>
</div>

<ul class="org-ul">
<li>class や module のブロックは定義時に実行</li>
<li>def のブロックはメソッド呼び出し時に実行</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgheadline131" class="outline-4">
<h4 id="orgheadline131">スコープのフラット化</h4>
<div class="outline-text-4" id="text-orgheadline131">
<p>
<a href="://~suzuki/COMM/Lects/meta-ruby/code/blocks/flat_scope_1.rb">://~suzuki/COMM/Lects/meta-ruby/code/blocks/flat_scope_1.rb</a>
</p>
</div>

<div id="outline-container-orgheadline132" class="outline-5">
<h5 id="orgheadline132">クラスゲートを越える</h5>
<div class="outline-text-5" id="text-orgheadline132">
<dl class="org-dl">
<dt>方針</dt><dd>class と同じ効果のあるメソッドに，my_var を閉じ込めたクロー
ジャを渡す</dd>

<dt>code</dt><dd><a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/flat_scope2.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/flat_scope2.rb</a></dd>
</dl>
</div>
</div>

<div id="outline-container-orgheadline133" class="outline-5">
<h5 id="orgheadline133">メソッドゲートを越える</h5>
<div class="outline-text-5" id="text-orgheadline133">
<dl class="org-dl">
<dt>方針</dt><dd>define_method に，my_var を閉じ込めたクロージャを渡す</dd>

<dt>code</dt><dd><a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/flat_scope3.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/flat_scope3.rb</a></dd>
</dl>
</div>
</div>

<div id="outline-container-orgheadline134" class="outline-5">
<h5 id="orgheadline134">スコープの共有化</h5>
<div class="outline-text-5" id="text-orgheadline134">
<p>
<a href="://~suzuki/COMM/Lects/meta-ruby/code/blocks/shared_scope.rb">://~suzuki/COMM/Lects/meta-ruby/code/blocks/shared_scope.rb</a>]]
</p>

<dl class="org-dl">
<dt>define_methodsの実行</dt><dd><ul class="org-ul">
<li>ブロック内で shared が定義され，</li>
<li>shared への参照と代入をもったクロージャを使って，
Kernel モジュール内に couter, inc メソッドを定義する</li>
<li>二つのメソッドからだけ参照できる安全な変数の生成</li>
</ul></dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-orgheadline135" class="outline-4">
<h4 id="orgheadline135">スコープのまとめ</h4>
<div class="outline-text-4" id="text-orgheadline135">
<ul class="org-ul">
<li>Rubyのスコープには束縛がある</li>
<li>スコープは class, module, def のスコープゲートで区切られ。</li>
<li>スコープゲートは，Class.new(), Module.new(), Moduel#define_method()
で置き換え，それらに束縛を閉じこめたクロージャを与える。</li>
<li>クロージャにより，束縛の共有も可能となる</li>
</ul>

<p>
(<b>s</b>) この辺りは，SICP の lambda による実現の方が，シンプルでわかりや
すい。
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline141" class="outline-3">
<h3 id="orgheadline141"><span class="section-number-3">5.4</span> instance_eval()</h3>
<div class="outline-text-3" id="text-5-4">
<p>
コードと束縛を好きなように組み合わせるもう一つの方法
</p>

<dl class="org-dl">
<dt>obj.instance_eval block</dt><dd><ul class="org-ul">
<li>オブジェクトobjのコンテキストで,</li>
<li>ブロックblockを評価する</li>
</ul>
<p>
<a href="://~suzuki/COMM/Lects/meta-ruby/code/blocks/instance_eval.rb">://~suzuki/COMM/Lects/meta-ruby/code/blocks/instance_eval.rb</a>
</p>

<pre class="example">
v = 2
obj.instance_eval { @v = v }
obj.instance_eval { @v }
</pre>

<p>
生成された環境でのローカル変数にも，
</p></dd>
</dl>
<p>
　objのインスタンス変数にもアクセスできる
</p>

<p>
objをselfにして, クロージャを実行するということ
</p>
</div>

<div id="outline-container-orgheadline137" class="outline-4">
<h4 id="orgheadline137">instance_exec (ruby 1.9)</h4>
<div class="outline-text-4" id="text-orgheadline137">
<div class="org-src-container">

<pre class="src src-ruby">class C
  def initialize
    @x, @y = 1, 2
  end
end

C.new.instance_exec(3) {|arg| (@x+@y) * arg }
</pre>
</div>
</div>
</div>


<div id="outline-container-orgheadline138" class="outline-4">
<h4 id="orgheadline138">カプセル化の破壊</h4>
<div class="outline-text-4" id="text-orgheadline138">
<p>
instance_eval を使うとカプセル化が破壊できる
</p>

<p>
カプセル化の破壊が正当化されることもある
</p>
</div>

<div id="outline-container-orgheadline139" class="outline-5">
<h5 id="orgheadline139">RSpecの例</h5>
<div class="outline-text-5" id="text-orgheadline139">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/rspec.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/rspec.rb</a>
</p>


<div class="org-src-container">

<pre class="src src-ruby">@object = Object.new
@object.instance_eval { @options = Object.new }
@object.should_receive(:blah)
@object.blah
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline140" class="outline-4">
<h4 id="orgheadline140">クリーンルーム</h4>
<div class="outline-text-4" id="text-orgheadline140">
<dl class="org-dl">
<dt>クリーンルーム</dt><dd>ブロックを評価するためだけに作られたオブジェク
トのこと</dd>
</dl>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/clean_room.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/clean_room.rb</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline152" class="outline-3">
<h3 id="orgheadline152"><span class="section-number-3">5.5</span> 呼び出し可能オブジェクト</h3>
<div class="outline-text-3" id="text-5-5">
<p>
ブロックの使用
</p>
<ul class="org-ul">
<li>コードの保管</li>
<li>ブロックをyieldを使った呼び出し</li>
</ul>

<p>
コードを保管できる状況
</p>
<ul class="org-ul">
<li>(({Proc})) の中．ブロックがオブジェクトになる</li>
<li>(({lambda})) の中．</li>
<li>メソッドの中</li>
</ul>
</div>

<div id="outline-container-orgheadline142" class="outline-5">
<h5 id="orgheadline142">Procオブジェクト</h5>
<div class="outline-text-5" id="text-orgheadline142">
<p>
ブロックはオブジェクトではないが,
Proc はブロックをオブジェクトにでき, 
後から呼び出せる (((<b>遅延評価</b>)))
</p>

<div class="org-src-container">

<pre class="src src-ruby">inc = Proc.new { |x| x+1 }
inc.call(2) #=&gt; 3
'end'
</pre>
</div>

<p>
カーネルメソッド (({lambda})), (({proc})) も
ブロックを(({Proc}))に変換できる．
</p>

<pre class="example">
dec = lambda { |x| x-1 }
dec.class # =&gt; Proc
dec.call(2) # =&gt; 1
</pre>
</div>

<div id="outline-container-orgheadline143" class="outline-6">
<h6 id="orgheadline143">&amp;修飾</h6>
<div class="outline-text-6" id="text-orgheadline143">
<ul class="org-ul">
<li>他のメソッドをブロックに渡す</li>
<li>ブロックをProcに変換する</li>
</ul>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/ampersand.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/ampersand.rb</a>
</p>

<ul class="org-ul">
<li>ブロックを 引数 &amp;operation で受ける</li>
<li>&amp;operationを渡すとブロックを渡すことになる</li>
</ul>

<pre class="example">
def my_method(&amp;the_proc)
  the_proc
end

p = my_method {|name| "Hello, #{name}"}
puts p.class
puts p.call("Bill") 
</pre>
<p>
=&gt;
</p>
<pre class="example">
Proc
Hello, Bill
</pre>

<p>
&amp;the_proc は，ブロックを(({Proc}))に変換して受ける
次の the_proc は，(({Proc})) 値を返す
</p>

<p>
(({Proc})) をブロックへ戻すには
</p>

<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/proc_to_block.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/proc_to_block.rb</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline144" class="outline-6">
<h6 id="orgheadline144">HighLineの例</h6>
<div class="outline-text-6" id="text-orgheadline144">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/highline_example.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/highline_example.rb</a>
</p>

<pre class="example">
name = hl.ask("Name?", lambda {|s| s.capitalize})
puts "Hello, #{name}"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline145" class="outline-5">
<h5 id="orgheadline145">Proc 対 lambda</h5>
<div class="outline-text-5" id="text-orgheadline145">
<p>
ブロックを Proc にする方法
</p>
<ul class="org-ul">
<li>Proc.new()</li>
<li>lambda { }　</li>
<li>&amp;修飾</li>
<li>&#x2026;</li>
</ul>

<p>
Proc と lambda でできるオブジェクトは少し違う
</p>
<ul class="org-ul">
<li>Proc は <i>Proc</i>, lambda は <i>lambda</i></li>
</ul>


<p>
<a href="https://d.hatena.ne.jp/vividcode/20100813/1281709854">https://d.hatena.ne.jp/vividcode/20100813/1281709854</a>]] が詳しい
</p>

<p>
<a href="https://doc.okkez.net/static/193/doc/spec=2flambda_proc.html">https://doc.okkez.net/static/193/doc/spec=2flambda_proc.html</a>
</p>
</div>

<div id="outline-container-orgheadline146" class="outline-6">
<h6 id="orgheadline146">Proc, lambda, return</h6>
<div class="outline-text-6" id="text-orgheadline146">
<p>
<a href="file://~suzuki/COMM/Lects/meta-ruby/code/blocks/proc_vs_lambda.rb">file://~suzuki/COMM/Lects/meta-ruby/code/blocks/proc_vs_lambda.rb</a>
</p>

<pre class="example">
def double(callable_object)
  callable_object.call * 2
end
l = lambda { return 10 }
double(l) # =&gt; 20
</pre>

<p>
lambda はメソッド
</p>

<pre class="example">
def another_double
  p = Proc.new { return 10 }
  result = p.call
  return result * 2
end
another_double # =&gt; 10
</pre>

<p>
<a href="https://doc.okkez.net/static/193/doc/spec=2flambda_proc.html">https://doc.okkez.net/static/193/doc/spec=2flambda_proc.html</a>
</p>

<p>
Proc のリターンは，Proc の定義された環境から return 
(直前の環境へ戻る)
</p>
</div>
</div>

<div id="outline-container-orgheadline147" class="outline-6">
<h6 id="orgheadline147">Proc, lambda, arity</h6>
<div class="outline-text-6" id="text-orgheadline147">
<p>
引数の確認方法の違い
</p>

<ul class="org-ul">
<li>lambda は厳格 (メソッドに準拠)</li>
<li>Proc は柔軟</li>
</ul>

<pre class="example">
p = Proc.new { |a,b| [a, b]}
p.arity # =&gt; 2
</pre>

<pre class="example">
p.call(1, 2, 3) # =&gt; [1, 2]
p.call(1) # =&gt; [1, nil]
</pre>
</div>
</div>

<div id="outline-container-orgheadline148" class="outline-6">
<h6 id="orgheadline148">Proc対lambda: 判定</h6>
<div class="outline-text-6" id="text-orgheadline148">
<p>
lambda がメソッドに似ている <code>[/]</code>
</p>
<ol class="org-ol">
<li class="off"><code>[&#xa0;]</code> 項数に厳しく</li>
<li class="off"><code>[&#xa0;]</code> return で自身を終える</li>
</ol>


<p>
Proc はコンテキスト中のコードの一部，
lambda は独立したコード
</p>
</div>
</div>

<div id="outline-container-orgheadline149" class="outline-6">
<h6 id="orgheadline149">Kernel#proc</h6>
</div>
</div>

<div id="outline-container-orgheadline150" class="outline-5">
<h5 id="orgheadline150">メソッド再び</h5>
<div class="outline-text-5" id="text-orgheadline150">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/methods.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/methods.rb</a>]]
</p>

<ul class="org-ul">
<li>Object#method() でメソッドを，Method オブジェクトとして取得可</li>
<li>Method オブジェクトは，Method#call() で呼び出し可能</li>
<li>Method オブジェクトは，属するオブジェクトのスコープで実行される</li>
<li>Method#unbind() は属するオブジェクトを引き離し，UnboundMethod
オブジェクトが返る</li>
<li>UnboundMethodはMethod#bind()でメソッドに戻せる
クラスが異なると，例外が発生</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline151" class="outline-5">
<h5 id="orgheadline151">呼び出し可能オブジェクトのまとめ</h5>
<div class="outline-text-5" id="text-orgheadline151">
<p>
呼び出し可能オブジェクト <code>[/]</code>
</p>
<ol class="org-ol">
<li class="off"><code>[&#xa0;]</code> ブロック
<ul class="org-ul">
<li>オブジェクトではないが，呼び出し可能</li>
<li>定義されたスコープで評価される</li>
</ul></li>
<li class="off"><code>[&#xa0;]</code> Proc
<ul class="org-ul">
<li>定義されたスコープで評価される</li>
</ul></li>
<li class="off"><code>[&#xa0;]</code> lambda
<ul class="org-ul">
<li>Proc クラスのオブジェクト，クロージャ</li>
<li>定義されたスコープで評価される</li>
</ul></li>
<li class="off"><code>[&#xa0;]</code> メソッド
<ul class="org-ul">
<li>オブジェクトにつながれ，</li>
<li>オブジェクトのスコープで評価される</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgheadline161" class="outline-3">
<h3 id="orgheadline161"><span class="section-number-3">5.6</span> ドメイン特化言語を書く</h3>
<div class="outline-text-3" id="text-5-6">
<p>
イベントの定義
</p>

<pre class="example">
event "注文が殺到" {
  recent_orders = ... # （データベースから読み込む)
  recent_orders &gt; 1000
}
</pre>
</div>

<div id="outline-container-orgheadline153" class="outline-6">
<h6 id="orgheadline153">初めてのDSL</h6>
<div class="outline-text-6" id="text-orgheadline153">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_blocks/redflag.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_blocks/redflag.rb</a>
</p>

<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_blocks/test_events.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_blocks/test_events.rb</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline154" class="outline-6">
<h6 id="orgheadline154">イベント間の共有</h6>
<div class="outline-text-6" id="text-orgheadline154">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_blocks/more_test_events.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_blocks/more_test_events.rb</a>
</p>

<p>
setup で共有変数の初期化をし，
event で共有変数を参照する
</p>
</div>
</div>

<div id="outline-container-orgheadline155" class="outline-5">
<h5 id="orgheadline155">クイズ: より良い DSL</h5>
<div class="outline-text-5" id="text-orgheadline155">
<p>
setup 命令の追加
</p>
</div>

<div id="outline-container-orgheadline156" class="outline-6">
<h6 id="orgheadline156">ビルの逃亡</h6>
<div class="outline-text-6" id="text-orgheadline156">
<pre class="example">
def event(name, &amp;block)
  @events[name] = block 
end
</pre>
</div>
</div>

<div id="outline-container-orgheadline157" class="outline-6">
<h6 id="orgheadline157">クイズの答え</h6>
<div class="outline-text-6" id="text-orgheadline157">
<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_framework/redflag.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_framework/redflag.rb</a>
</p>
</div>

<div id="outline-container-orgheadline158" class="outline-7">
<h7 id="orgheadline158">redfalg.rb の中身</h7>
<div class="outline-text-7" id="text-orgheadline158">
<p>
*events.rb という名前のファイルすべてに対して
</p>

<p>
ファイルをロード (実行) し，
    定義されたイベント組に対し，
</p>

<p>
新しいオブジェクトをクリーンルーム用に作成し，
</p>

<p>
定義されたセットアップに対し，
  クリーンルーム内でセットアップを実行する
</p>

<p>
    クリーンルーム内でイベントを実行し，
イベントがあれば，アラートを出す
</p>
</div>
</div>

<div id="outline-container-orgheadline159" class="outline-7">
<h7 id="orgheadline159">@setups, @events はグローバル変数のようで良くない</h7>
</div>
</div>

<div id="outline-container-orgheadline160" class="outline-6">
<h6 id="orgheadline160">もっと良いDSL</h6>
<div class="outline-text-6" id="text-orgheadline160">
<p>
共有スコープをつかってグローバル変数を取り除く
</p>

<p>
<a href="file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_final/redflag.rb">file:///users/home/masayuki/COMM/Lects/meta-ruby/code/blocks/monitor_final/redflag.rb</a>
</p>

<p>
lambda を使い，
  共有スコープのために 
  event, setup, each_event, each_setup メソッドを動的に定義
する
</p>

<p>
*events.rb という名前のファイルすべてに対して
  ファイルをロード (実行) し，
    定義されたイベント組に対し，
</p>

<p>
新しいオブジェクトをクリーンルーム用に作成し，
</p>

<p>
定義されたセットアップに対し，
  クリーンルーム内でセットアップを実行する
</p>

<p>
    クリーンルーム内でイベントを実行し，
イベントがあれば，アラートを出す
</p>

<p>
(<b>s</b>) 
</p>
<ul class="org-ul">
<li>load するファイルごとに，eventsとsetups を nil に初期化する必
要あり?</li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-orgheadline162" class="outline-3">
<h3 id="orgheadline162"><span class="section-number-3">5.7</span> 参考</h3>
<div class="outline-text-3" id="text-5-7">
<p>
rhg source eval.c#Init_Proc
</p>
</div>
</div>
</div>
<div id="outline-container-orgheadline174" class="outline-2">
<h2 id="orgheadline174"><span class="section-number-2">6</span> メタプログラミング Ruby のまとめ</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-orgheadline164" class="outline-3">
<h3 id="orgheadline164"><span class="section-number-3">6.1</span> 計算のモデルとプログラミング言語</h3>
<div class="outline-text-3" id="text-6-1">
<dl class="org-dl">
<dt>値</dt><dd>計算への入力であり，出力
<dl class="org-dl">
<dt>コード</dt><dd>入力  =&gt; op =&gt; 出力</dd>
<dt>変数</dt><dd>状態</dd>
</dl></dd>
<dt>(no term)</dt><dd>コードと変数のスコープ</dd>
</dl>
</div>
</div>

<div id="outline-container-orgheadline165" class="outline-3">
<h3 id="orgheadline165"><span class="section-number-3">6.2</span> オブジェクト指向パラダイムとは</h3>
</div>

<div id="outline-container-orgheadline173" class="outline-3">
<h3 id="orgheadline173"><span class="section-number-3">6.3</span> rubyのやり方</h3>
<div class="outline-text-3" id="text-6-3">
</div><div id="outline-container-orgheadline166" class="outline-4">
<h4 id="orgheadline166">オブジェクトモデル</h4>
</div>
<div id="outline-container-orgheadline167" class="outline-4">
<h4 id="orgheadline167">クラスもオブジェクト</h4>
</div>
<div id="outline-container-orgheadline168" class="outline-4">
<h4 id="orgheadline168">名前の探索</h4>
</div>
<div id="outline-container-orgheadline169" class="outline-4">
<h4 id="orgheadline169">動的な定義</h4>
</div>
<div id="outline-container-orgheadline170" class="outline-4">
<h4 id="orgheadline170">メタプログラマブル</h4>
</div>
<div id="outline-container-orgheadline171" class="outline-4">
<h4 id="orgheadline171">スコープとクロージャで，ブロックもオブジェクト</h4>
</div>
<div id="outline-container-orgheadline172" class="outline-4">
<h4 id="orgheadline172">オブジェクトと特異クラスとクラス階層</h4>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: suzuki@cis.iwate-u.ac.jp</p>
<p class="date">Created: 2016-11-21 月 09:41</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
